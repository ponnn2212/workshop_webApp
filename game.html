<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน้าเกม</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container game-container">
        <h1 id="gameTitle" class="game-title">รอกดปุ่ม...</h1>
        <p class="player-info">คุณ: <strong id="displayPlayerName"></strong> | ห้อง: <strong id="displayRoomCode"></strong></p>
        <button id="buzzButton" class="buzz-button wait" onclick="buzz()">WAIT</button>
        <p id="message" class="game-message"></p>
    </div>

    <script>
        const playerName = localStorage.getItem('currentPlayerName');
        const roomCode = localStorage.getItem('currentPlayerRoomCode');

        document.addEventListener('DOMContentLoaded', () => {
            if (!playerName || !roomCode) {
                document.getElementById('gameTitle').textContent = 'กรุณาเข้าร่วมห้องก่อน';
                document.getElementById('buzzButton').style.display = 'none';
                return;
            }

            document.getElementById('displayPlayerName').textContent = playerName;
            document.getElementById('displayRoomCode').textContent = roomCode;

            setInterval(checkGameStatus, 200);
        });

        function updateButtonState(buttonState) {
            const buzzButton = document.getElementById('buzzButton');
            buzzButton.classList.remove('wait', 'buzz', 'done', 'foul');
            buzzButton.disabled = false;

            if (buttonState === 'wait') {
                buzzButton.classList.add('wait');
                buzzButton.textContent = 'WAIT';
                // ปุ่มจะเปิดใช้งานได้เสมอเพื่อรับการ Foul ก่อนเริ่มเกม
            } else if (buttonState === 'buzz') {
                buzzButton.classList.add('buzz');
                buzzButton.textContent = 'BUZZ';
            } else if (buttonState === 'done') {
                buzzButton.classList.add('done');
                buzzButton.textContent = 'DONE';
                buzzButton.disabled = true;
            } else if (buttonState === 'foul') {
                buzzButton.classList.add('foul');
                buzzButton.textContent = 'FOUL!';
                buzzButton.disabled = true;
            }
        }

        function checkGameStatus() {
            let roomData = JSON.parse(localStorage.getItem('gameRoom'));
            const buzzButton = document.getElementById('buzzButton');
            const gameTitleElem = document.getElementById('gameTitle');
            const messageElem = document.getElementById('message');

            if (!roomData || roomData.code != roomCode || !roomData.players[playerName]) {
                gameTitleElem.textContent = 'ห้องไม่พร้อมใช้งาน';
                buzzButton.style.display = 'none';
                messageElem.textContent = 'กลับไปที่หน้าเข้าร่วมห้องเพื่อลองอีกครั้ง';
                return;
            }

            const currentPlayerInRoom = roomData.players[playerName];

            if (currentPlayerInRoom.isFoul) {
                updateButtonState('foul');
                gameTitleElem.textContent = 'คุณกดก่อนเกมเริ่ม!';
                messageElem.textContent = 'รอรอบใหม่นะ!';
            } else if (roomData.gameStarted) {
                if (currentPlayerInRoom.buzzedTime) {
                    updateButtonState('done');
                    if (roomData.firstBuzzer === playerName) {
                        gameTitleElem.textContent = 'คุณกดเป็นคนแรก!';
                    } else if (roomData.firstBuzzer) {
                        gameTitleElem.textContent = `ผู้กดคนแรก: ${roomData.firstBuzzer}`;
                        messageElem.textContent = 'มีคนกดไปก่อนคุณแล้ว!';
                    } else {
                        gameTitleElem.textContent = 'คุณกดแล้ว!';
                        messageElem.textContent = '';
                    }
                } else {
                    updateButtonState('buzz');
                    gameTitleElem.textContent = 'เกมเริ่มแล้ว! กด BUZZ!';
                    messageElem.textContent = '';
                }
            } else {
                updateButtonState('wait');
                gameTitleElem.textContent = 'รอกดปุ่ม...';
                messageElem.textContent = '';
            }
        }

        function buzz() {
            let roomData = JSON.parse(localStorage.getItem('gameRoom'));
            const currentPlayerInRoom = roomData.players[playerName];

            if (currentPlayerInRoom.buzzedTime !== null || currentPlayerInRoom.isFoul) {
                return;
            }

            const buzzTime = Date.now();

            if (!roomData.gameStarted) {
                currentPlayerInRoom.buzzedTime = buzzTime;
                currentPlayerInRoom.isFoul = true;
                currentPlayerInRoom.isWaiting = false;
                localStorage.setItem('gameRoom', JSON.stringify(roomData));
                console.log(`${playerName} FOUL!`);
                updateButtonState('foul');
                document.getElementById('gameTitle').textContent = 'คุณกดก่อนเกมเริ่ม!';
                document.getElementById('message').textContent = 'รอรอบใหม่นะ!';
            } else {
                currentPlayerInRoom.buzzedTime = buzzTime;
                currentPlayerInRoom.isWaiting = false;
                
                if (!roomData.firstBuzzer) {
                    roomData.firstBuzzer = playerName;
                }
                roomData.buzzedOrder.push({ name: playerName, time: buzzTime });

                localStorage.setItem('gameRoom', JSON.stringify(roomData));
                console.log(`${playerName} buzzed at ${buzzTime}`);
                updateButtonState('done');
                document.getElementById('gameTitle').textContent = `คุณกดแล้ว!`;
                document.getElementById('message').textContent = '';
            }
        }
    </script>
</body>
</html>