<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เข้าร่วมห้อง</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container join-room-container">
        <h1>เข้าร่วมห้อง</h1>
        <div class="input-group">
            <label for="roomCode">รหัสห้อง (4 ตัว):</label>
            <input type="text" id="roomCode" maxlength="4" placeholder="ใส่รหัสห้อง">
        </div>
        <div class="input-group">
            <label for="playerName">ชื่อของคุณ:</label>
            <input type="text" id="playerName" placeholder="ใส่ชื่อของคุณ">
        </div>
        <button class="primary-button" onclick="joinRoom()">เข้าร่วม</button>
        <p id="joinStatus" class="error-message"></p>
    </div>

    <!-- โหลด script.js ก่อน script ส่วนนี้ -->
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const savedPlayerName = localStorage.getItem('currentPlayerName');
            const savedRoomCode = localStorage.getItem('currentPlayerRoomCode');
            if (savedPlayerName) {
                document.getElementById('playerName').value = savedPlayerName;
            }
            if (savedRoomCode) {
                document.getElementById('roomCode').value = savedRoomCode;
            }
        });

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim();
            const playerNameInput = document.getElementById('playerName');
            const playerName = playerNameInput.value.trim();
            const joinStatusElem = document.getElementById('joinStatus');

            if (!roomCode || roomCode.length !== 4) {
                joinStatusElem.textContent = 'Invalid: กรุณาใส่รหัสห้อง 4 ตัว';
                return;
            }
            if (!playerName) {
                joinStatusElem.textContent = 'Invalid: กรุณาใส่ชื่อของคุณ';
                return;
            }
            if (!isValidName(playerName)) { // ใช้ isValidName จาก script.js
                joinStatusElem.textContent = 'Invalid: ชื่อของคุณห้ามมีอักขระพิเศษ (อนุญาตเฉพาะตัวอักษรไทย, อังกฤษ, ตัวเลข)';
                return;
            }
            joinStatusElem.textContent = ''; // เคลียร์ error ถ้ามี

            let roomData = JSON.parse(localStorage.getItem('gameRoom'));

            if (roomData && roomData.code == roomCode) {
                // ตรวจสอบชื่อซ้ำ (กรณีผู้เล่นคนอื่น)
                const existingPlayerNames = Object.keys(roomData.players).map(name => name.toLowerCase());
                if (existingPlayerNames.includes(playerName.toLowerCase()) && roomData.players[playerName] === undefined) {
                    joinStatusElem.textContent = 'Invalid: ชื่อนี้มีคนใช้แล้วในห้องนี้ กรุณาใช้ชื่ออื่น';
                    return;
                }
                
                // หากผู้เล่นเคยเข้ามาด้วยชื่อนี้แล้ว (และไม่ได้เปลี่ยนชื่อ) ก็ถือว่าไม่ซ้ำ
                // แต่หากเปลี่ยนชื่อมาเป็นชื่อที่ซ้ำกับคนอื่น (ซึ่งก่อนหน้านี้เคยใช้ชื่ออื่น) ก็ยังถือว่าซ้ำ

                // เพิ่มผู้เล่นเข้ารายการ (ถ้ายังไม่มีชื่อนี้)
                if (!roomData.players[playerName]) {
                    roomData.players[playerName] = {
                        name: playerName,
                        buzzedTime: null,
                        isFoul: false,
                        isWaiting: true
                    };
                    localStorage.setItem('gameRoom', JSON.stringify(roomData));
                } else {
                     // หากผู้เล่นคนเดิมเข้ามาอีกครั้ง
                     // ถ้าเกมยังไม่เริ่มและผู้เล่นคนนี้เคย Foul มาก่อน ก็รีเซ็ต Foul ให้
                    if (!roomData.gameStarted && roomData.players[playerName].isFoul) {
                        roomData.players[playerName].isFoul = false;
                        roomData.players[playerName].buzzedTime = null;
                        roomData.players[playerName].isWaiting = true;
                        localStorage.setItem('gameRoom', JSON.stringify(roomData));
                    }
                }
                
                localStorage.setItem('currentPlayerName', playerName);
                localStorage.setItem('currentPlayerRoomCode', roomCode);

                window.location.href = 'game.html';
            } else {
                joinStatusElem.textContent = 'Invalid: ไม่พบห้องหรือรหัสห้องไม่ถูกต้อง';
            }
        }
    </script>
</body>
</html>